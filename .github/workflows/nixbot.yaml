name: nixbot

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      hosts:
        description: Comma/space-separated hosts, or all
        required: true
        default: all
        type: string
      deploy:
        description: Run deploy (otherwise build only)
        required: true
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  run:
    if: github.ref == 'refs/heads/master'
    name: Trigger nixbot
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Verify Tailscale OAuth secrets in CI
        shell: bash
        env:
          TS_OAUTH_CLIENT_ID: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          TS_OAUTH_SECRET: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        run: |
          set -euo pipefail

          echo "id_len=${#TS_OAUTH_CLIENT_ID} secret_len=${#TS_OAUTH_SECRET}"
          code="$(curl -sS -o /tmp/ts-oauth-token.json -w '%{http_code}' \
            -u "${TS_OAUTH_CLIENT_ID}:${TS_OAUTH_SECRET}" \
            -d 'grant_type=client_credentials' \
            -d 'scope=auth_keys' \
            -d 'tags=tag:ci' \
            https://api.tailscale.com/api/v2/oauth/token)"
          echo "oauth_token_http_code=${code}"
          cat /tmp/ts-oauth-token.json
          test "${code}" = "200"

      - name: Connect to Tailscale
        id: tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci
          args: --accept-routes
          version: latest
          use-cache: "false"

      - name: Trigger deploy from bastion over SSH
        if: steps.tailscale.outcome == 'success'
        shell: bash
        env:
          BASTION_HOST: ${{ secrets.NIXBOT_BASTION_HOST }}
          BASTION_USER: ${{ secrets.NIXBOT_BASTION_USER }}
          BASTION_SSH_KEY: ${{ secrets.NIXBOT_BASTION_SSH_KEY }}
          BASTION_KNOWN_HOSTS: ${{ secrets.NIXBOT_BASTION_KNOWN_HOSTS }}
          INPUT_HOSTS: ${{ github.event.inputs.hosts }}
          INPUT_DEPLOY: ${{ github.event.inputs.deploy }}
          EVENT_NAME: ${{ github.event_name }}
          GIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          host="${BASTION_HOST:-?BASTION_HOST not set}"
          user="${BASTION_USER:-?BASTION_USER not set}"
          if [ -z "${BASTION_SSH_KEY:-}" ]; then
            echo "Missing required secret: NIXBOT_BASTION_SSH_KEY" >&2
            exit 1
          fi

          hosts="all"
          action="build"

          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            hosts="${INPUT_HOSTS:-all}"
            if [ "${INPUT_DEPLOY:-true}" = "true" ]; then
              action="deploy"
            fi
          fi

          if [ "${hosts}" != "all" ]; then
            hosts="$(printf '%s' "${hosts}" \
              | tr ', ' '\n\n' \
              | sed '/^$/d' \
              | sort -u \
              | paste -sd, -)"
            if [ -z "${hosts}" ]; then
              echo "No valid hosts after normalization" >&2
              exit 1
            fi
          fi

          key_file="$(mktemp)"
          known_hosts_file="$(mktemp)"
          chmod 600 "${key_file}" "${known_hosts_file}"
          printf '%s\n' "${BASTION_SSH_KEY}" > "${key_file}"

          if [ -n "${BASTION_KNOWN_HOSTS:-}" ]; then
            printf '%s\n' "${BASTION_KNOWN_HOSTS}" > "${known_hosts_file}"
          else
            ssh-keyscan -H "${host}" > "${known_hosts_file}" 2>/dev/null
          fi

          ssh_opts=(
            -i "${key_file}"
            -o IdentitiesOnly=yes
            -o StrictHostKeyChecking=yes
            -o UserKnownHostsFile="${known_hosts_file}"
          )

          ssh "${ssh_opts[@]}" -- "${user}@${host}" \
            "--sha ${GIT_SHA} --hosts ${hosts} --action ${action}"

          rm -f "${key_file}" "${known_hosts_file}"
